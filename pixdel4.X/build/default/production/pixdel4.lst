MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;NOM: pixdel4.asm
                      00002 ;DESCRIPTION: version 3 du pixdel (version simplifiée).
                      00003 ;             LED RGB controlée par un PIC10F200 ou PIC10F202
                      00004 ;             commandes reçues sur GP3 en format UART 8 bits, pas de parité, 1 stop.
                      00005 ;
                      00006 ;             format commande:
                      00007 ;             0xFF id_pixdel r_level g_level b_level
                      00008 ;               0xFF synchronisation, ne doit pas être utilisé comme id_pixdel ou niveau d'intensité.
                      00009 ;               id_pixdel 0 = diffusion, id_unique 1-254
                      00010 ;               r_level niveau de rouge 0-254
                      00011 ;               g_level niveau de vert 0-254
                      00012 ;               b_level niveau de bleu 0-254
                      00013 ;
                      00014 ;MCU: PIC10F200 ou 202
                      00015 ;DATE: 2013-03-05
                      00016 ;AUTEUR: Jacques Deschênes
                      00017 ;REVISION: 2013-03-23
                      00018 ;          version 4, augmentation de la vitesse uart_rx à 38400 BAUD
                      00019 
                      00020 
                      00021   include <P10F202.INC>
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ;  MPASM PIC10F202 processor include
                      00005 ; 
                      00006 ;  (c) Copyright 1999-2013 Microchip Technology, All rights reserved
                      00007 ;==========================================================================
                      00008 
                      00150         LIST
                      00022 
0FFF   0FEB           00023   __config _WDTE_OFF & _MCLRE_OFF
                      00024 
                      00025 ;;;;;;;;;;;;; constantes ;;;;;;;;;;;;;;
                      00026 ;PIXDEL_ID EQU 1 ; 1-255 doit-être différent pour chaque pixdel
                      00027 ; pour des raisons pratique PIXDEL_ID est maintenant défini sur comme macro
                      00028 ; de ligne de commande mpasm.   mpasm -d PIXDEL_ID=n
                      00029 ;
                      00030 
  00000000            00031 BROADCAST EQU 0 ; identifiant message de diffusion
                      00032 
  000000C8            00033 OPTION_CFG EQU B'11001000' ; configuration registre OPTION
                      00034 
  00000003            00035 RX_P EQU GP3 ; réception uart
  00000001            00036 TX_P EQU GP1 ; transmission uart
                      00037 
  00000005            00038 CMD_SIZE EQU 5 ;  octets par commande
                      00039 
                      00040 ; bits couleurs rgb dans GPIO
  00000000            00041 GREEN   EQU GP0
  00000001            00042 BLUE    EQU GP1
  00000002            00043 RED     EQU GP2
                      00044 
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00045 
                      00046 ; délais de bit pour 9600 BAUD
  00000068            00047 BDLY_9600 EQU D'104' ;
  00000034            00048 HDLY_9600 EQU D'52' ; délais demi-bit
  00000045            00049 BDLY_14400 EQU D'69'
  00000023            00050 HDLY_14400 EQU D'35'
                      00051 ;délais de bit pour 19200 BAUD
  00000034            00052 BDLY_19200 EQU D'52'
  0000001A            00053 HDLY_19200 EQU D'26'
                      00054 ; délais de bit pour 38400 BAUD
  0000001A            00055 BDLY_38400 EQU  D'26'
  0000000D            00056 HDLY_38400 EQU  D'13'
                      00057 
  00000068            00058 BIT_DLY  EQU BDLY_9600
  00000034            00059 HALF_DLY EQU HDLY_9600
  FFFFFFCC            00060 PWM_PERIOD EQU (~HALF_DLY) + 1 ; période entre chaque appel de pwm_clock
                      00061 
                      00062 ; indicateurs booléens
  00000000            00063 F_IDLE EQU 0 ; pas de réception en cours
  00000001            00064 F_RDBIT EQU 1  ; toggle lecture bit à tous les 2 cycles
  00000002            00065 F_STOP EQU 2  ; réception stop bit
  00000004            00066 F_CMD  EQU 4 ; commande reçu et prête à être lue
                      00067 
                      00068 
                      00069 ;;;;;;;;;;;;; macros ;;;;;;;;;;;;;;;;;;
                      00070 #define DEBUG
                      00071 
                      00072 #define RX GPIO, RX_P
                      00073 #define TX GPIO, TX_P
                      00074 
                      00075 ; délais en micro-secondes basé sur un Tcy de 1usec.
                      00076 ; délais maximal  3*255+2=767usec
                      00077 delay_us macro usec
                      00078   local q=(usec-2)/3
                      00079   if q>0
                      00080     movlw q
                      00081     movwf delay_cntr
                      00082     decfsz delay_cntr,F
                      00083     goto $-1
                      00084     nop
                      00085     local r=(usec-2) % 3
                      00086     while r>1
                      00087       goto $+1
                      00088       local r=r-2
                      00089     endw
                      00090     if r>0
                      00091       nop
                      00092     endif
                      00093   else
                      00094     while usec>1
                      00095       goto $+1
                      00096       usec=usec-2
                      00097     endw
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00098     if usec>0
                      00099       nop
                      00100     endif
                      00101   endif
                      00102   endm
                      00103 
                      00104 init_rcv_state macro
                      00105     movlw CMD_SIZE
                      00106     movwf byte_cntr
                      00107     movlw rx_buff
                      00108     movwf FSR
                      00109     clrf flags
                      00110     bsf flags, F_IDLE
                      00111     endm
                      00112 
                      00113 
                      00114 ;;;;;;;;;;;;; variables ;;;;;;;;;;;;;;;
                      00115   udata
0000                  00116 flags res 1 ; indicateurs booléens
0001                  00117 uart_byte res 1 ; octet reçu sur entrée uart
0002                  00118 byte_cntr res 1 ; registre temporaire
0003                  00119 rx_buff res CMD_SIZE ; mémoire tampon réception des commandes
0008                  00120 delay_cntr res 1 ; compteur pour macro delay_us
0009                  00121 pwm res 1  ; compteur pwm
000A                  00122 dc_red res 1 ; rapport cyclique rouge
000B                  00123 dc_blue res 1 ; rapport cyclique bleu
000C                  00124 dc_green res 1 ; rappor cyclique vert
000D                  00125 gpio_temp res 1 ; variable temporaire état GPIO utilisé par tâche PWM.
                      00126 
                      00127 ;;;;;;;;;;;;; code ;;;;;;;;;;;;;;;;;;;;
                      00128 
                      00129 rst_vector org 0
0000   0A??           00130   goto init
                      00131 
0001                  00132 uart_rx
                      00133 ; réception RS-232 
0001   0700           00134   btfss flags, F_IDLE
0002   0A??           00135   goto receiving
0003   0666           00136   btfsc RX
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0004   0800           00137   return 
0005   0C80           00138   movlw H'80'
0006   0020           00139   movwf INDF
0007   0400           00140   bcf flags, F_IDLE
0008   0520           00141   bsf flags, F_RDBIT
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0009   0800           00142   return
000A                  00143 receiving
000A   0C02           00144   movlw 1<<F_RDBIT
000B   01??           00145   xorwf flags, F
000C   0720           00146   btfss flags, F_RDBIT
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
000D   0800           00147   return
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000E   0640           00148   btfsc flags, F_STOP
000F   0A??           00149   goto rcv_stop_bit
0010   0503           00150   setc
0011   0766           00151   btfss RX
0012   0403           00152   clrc
0013   0320           00153   rrf INDF, F
0014   0703           00154   skpc
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0015   0800           00155   return
0016   0540           00156   bsf flags, F_STOP
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0017   0800           00157   return
0018                  00158 rcv_stop_bit
0018   00??           00159   clrf flags
0019   0500           00160   bsf flags, F_IDLE
001A   02A4           00161   incf FSR, F
001B   02??           00162   decfsz byte_cntr, F
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
001C   0800           00163   return
001D   0580           00164   bsf flags, F_CMD
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
001E   0800           00165   return
                      00166 
                      00167 
                      00168 #ifdef DEBUG
001F                  00169 uart_tx
                      00170 ; transmet octet [uart_byte] , utilisé pur deboggage.
001F   0426           00171   bcf TX
                      00172   delay_us (BIT_DLY-D'6')
  0020                    M   local q=((BIT_DLY-D'6')-2)/3
                          M   if q>0
0020   0C20               M     movlw q
0021   00??               M     movwf delay_cntr
0022   02??               M     decfsz delay_cntr,F
0023   0A??               M     goto $-1
0024   0000               M     nop
  0000                    M     local r=((BIT_DLY-D'6')-2) % 3
                          M     while r>1
                          M       goto $+1
                          M       local r=r-2
                          M     endw
                          M     if r>0
                          M       nop
                          M     endif
                          M   else
                          M     while (BIT_DLY-D'6')>1
                          M       goto $+1
                          M       (BIT_DLY-D'6')=(BIT_DLY-D'6')-2
                          M     endw
                          M     if (BIT_DLY-D'6')>0
                          M       nop
                          M     endif
                          M   endif
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0025   0503           00173   setc
0026                  00174 tx_bit_loop
0026   03??           00175   rrf uart_byte, F
0027   0703           00176   skpc
0028   0426           00177   bcf TX
0029   0603           00178   skpnc
002A   0526           00179   bsf TX
                      00180   delay_us (BIT_DLY - D'10')
  001E                    M   local q=((BIT_DLY - D'10')-2)/3
                          M   if q>0
002B   0C1E               M     movlw q
002C   00??               M     movwf delay_cntr
002D   02??               M     decfsz delay_cntr,F
002E   0A??               M     goto $-1
002F   0000               M     nop
  0002                    M     local r=((BIT_DLY - D'10')-2) % 3
                          M     while r>1
0030   0A??               M       goto $+1
  0000                    M       local r=r-2
                          M     endw
                          M     if r>0
                          M       nop
                          M     endif
                          M   else
                          M     while (BIT_DLY - D'10')>1
                          M       goto $+1
                          M       (BIT_DLY - D'10')=(BIT_DLY - D'10')-2
                          M     endw
                          M     if (BIT_DLY - D'10')>0
                          M       nop
                          M     endif
                          M   endif
0031   0403           00181   clrc
0032   02??           00182   movf uart_byte, F
0033   0743           00183   skpz
0034   0A??           00184   goto tx_bit_loop
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0035   0800           00185   return
                      00186 
0036                  00187 echo
0036   0C??           00188   movlw rx_buff
0037   0024           00189   movwf FSR
0038   0C05           00190   movlw CMD_SIZE
0039   00??           00191   movwf byte_cntr
003A                  00192 echo_loop
003A   0200           00193   movfw INDF
003B   00??           00194   movwf uart_byte
003C   09??           00195   call uart_tx
Message[305]: Using default destination of 1 (file).
003D   02A4           00196   incf FSR
003E   02??           00197   decfsz byte_cntr, F
003F   0A??           00198   goto echo_loop
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0040   0800           00199   return
                      00200 
                      00201 #endif
                      00202 
                      00203 
0041                  00204 pwm_clock ; 16 uSec inclant call et return
0041   02??           00205     incf pwm, F
0042   02??           00206     movfw pwm
0043   00??           00207     subwf dc_red, W
0044   03??           00208     rlf gpio_temp, F
0045   02??           00209     movfw pwm
0046   00??           00210     subwf dc_blue, W
0047   03??           00211     rlf gpio_temp, F
0048   02??           00212     movfw pwm
0049   00??           00213     subwf dc_green, W
004A   03??           00214     rlf gpio_temp, F
004B   02??           00215     comf gpio_temp, W
                      00216 #ifdef DEBUG
004C   0000           00217     nop
                      00218 #else
                      00219     movwf GPIO
                      00220 #endif
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
004D   0800           00221     return
                      00222 
004E                  00223 read_cmd ;+4
004E   0C??           00224     movlw rx_buff
004F   0024           00225     movwf FSR
0050   0200           00226     movf INDF, W
0051   0643           00227     skpnz
0052   0A??           00228     goto accept_cmd
0053   0F01           00229     xorlw PIXDEL_ID
0054   0743           00230     skpz
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0055   0800           00231     return
0056                  00232 accept_cmd
0056   02A4           00233     incf FSR, F
0057   0240           00234     comf INDF, W
0058   00??           00235     movwf dc_red
0059   02A4           00236     incf FSR, F
005A   0240           00237     comf INDF, W
005B   00??           00238     movwf dc_green
005C   02A4           00239     incf FSR, F
005D   0240           00240     comf INDF, W
005E   00??           00241     movwf dc_blue
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
005F   0800           00242     return 
                      00243 
                      00244 
                      00245 ;;;;;;;;;;;; initialisation MCU ;;;;;;;
0060                  00246 init
0060   0C08           00247   movlw D'8' ; valeur obtenue expérimentalement par mesure de FOSC4 sur GP2
0061   0025           00248   movwf OSCCAL
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0062   0CC8           00249   movlw OPTION_CFG
0063   0002           00250   option
0064   0040           00251   clrw
0065   0006           00252   tris GPIO
0066   0546           00253   bsf GPIO, RED
0067   0506           00254   bsf GPIO, GREEN
0068   0526           00255   bsf GPIO, BLUE
0069   0CFF           00256   movlw D'255'
006A   00??           00257   movwf gpio_temp
006B   0061           00258   clrf TMR0
006C   0CFA           00259   movlw D'250'
006D   0081           00260   subwf TMR0, W
006E   0703           00261   skpc
006F   0A??           00262   goto $-3
0070   02??           00263   decfsz gpio_temp, F
0071   0A??           00264   goto $-6
0072   0066           00265   clrf GPIO
0073   00??           00266   clrf pwm
0074   0CFF           00267   movlw H'FF'
0075   00??           00268   movwf dc_red
0076   00??           00269   movwf dc_green
0077   00??           00270   movwf dc_blue
                      00271 #ifdef DEBUG
0078   0C4F           00272   movlw A'O'
0079   00??           00273   movwf uart_byte
007A   09??           00274   call uart_tx
007B   0C4B           00275   movlw A'K'
007C   00??           00276   movwf uart_byte
007D   00??           00277   movwf uart_byte
007E   09??           00278   call uart_tx
                      00279 #endif
                      00280   init_rcv_state
007F   0C05               M     movlw CMD_SIZE
0080   00??               M     movwf byte_cntr
0081   0C??               M     movlw rx_buff
0082   0024               M     movwf FSR
0083   00??               M     clrf flags
0084   0500               M     bsf flags, F_IDLE
0085   0061           00281   clrf TMR0
                      00282 
                      00283 ;;;;;;;;;;;; boucle principale ;;;;;;;;
0086                  00284 main
0086   0CCE           00285     movlw PWM_PERIOD + 2
Message[305]: Using default destination of 1 (file).
0087   01E1           00286     addwf TMR0
0088   09??           00287     call pwm_clock ; 16uSec
0089   09??           00288     call uart_rx   
008A   0780           00289     btfss flags, F_CMD
008B   0A??           00290     goto wait_loop
                      00291 #ifdef DEBUG
008C   09??           00292     call echo
                      00293 #else
                      00294     call read_cmd
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00295 #endif
                      00296     init_rcv_state
008D   0C05               M     movlw CMD_SIZE
008E   00??               M     movwf byte_cntr
008F   0C??               M     movlw rx_buff
0090   0024               M     movwf FSR
0091   00??               M     clrf flags
0092   0500               M     bsf flags, F_IDLE
0093   0A??           00297     goto main
0094                  00298 wait_loop
0094   0CCC           00299     movlw PWM_PERIOD
0095   0081           00300     subwf TMR0, W
0096   0603           00301     skpnc
0097   0A??           00302     goto wait_loop
0098   0A??           00303     goto main
0FEB                  00304     end
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE  9


SYMBOL TABLE
  LABEL                             VALUE 

BDLY_14400                        00000045
BDLY_19200                        00000034
BDLY_38400                        0000001A
BDLY_9600                         00000068
BIT_DLY                           00000068
BLUE                              00000001
BROADCAST                         00000000
C                                 00000000
CAL0                              00000001
CAL1                              00000002
CAL2                              00000003
CAL3                              00000004
CAL4                              00000005
CAL5                              00000006
CAL6                              00000007
CMD_SIZE                          00000005
DC                                00000001
DEBUG                             
F                                 00000001
FOSC4                             00000000
FSR                               00000004
F_CMD                             00000004
F_IDLE                            00000000
F_RDBIT                           00000001
F_STOP                            00000002
GP0                               00000000
GP1                               00000001
GP2                               00000002
GP3                               00000003
GPIO                              00000006
GPWUF                             00000007
GREEN                             00000000
HALF_DLY                          00000034
HDLY_14400                        00000023
HDLY_19200                        0000001A
HDLY_38400                        0000000D
HDLY_9600                         00000034
INDF                              00000000
NOT_GPPU                          00000006
NOT_GPWU                          00000007
NOT_PD                            00000003
NOT_TO                            00000004
OPTION_CFG                        000000C8
OSCCAL                            00000005
PCL                               00000002
PIXDEL_ID                         1
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PWM_PERIOD                        FFFFFFCC
RED                               00000002
RX                                GPIO, RX_P
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE 10


SYMBOL TABLE
  LABEL                             VALUE 

RX_P                              00000003
STATUS                            00000003
T0CS                              00000005
T0SE                              00000004
TMR0                              00000001
TRISIO0                           00000000
TRISIO1                           00000001
TRISIO2                           00000002
TRISIO3                           00000003
TX                                GPIO, TX_P
TX_P                              00000001
W                                 00000000
Z                                 00000002
_.org_0_0023                      00000023
_.org_0_002E                      0000002E
_.org_0_0030                      00000030
_.org_0_006F                      0000006F
_.org_0_0071                      00000071
_CONFIG                           00000FFF
_CP_OFF                           00000FFF
_CP_ON                            00000FF7
_IDLOC0                           00000200
_IDLOC1                           00000201
_IDLOC2                           00000202
_IDLOC3                           00000203
_IntRC_OSC                        00000FFF
_MCLRE_OFF                        00000FEF
_MCLRE_ON                         00000FFF
_OSC_IntRC                        00000FFF
_WDTE_OFF                         00000FFB
_WDTE_ON                          00000FFF
_WDT_OFF                          00000FFB
_WDT_ON                           00000FFF
__10F202                          00000001
accept_cmd                        00000056
byte_cntr                         00000002
dc_blue                           0000000B
dc_green                          0000000C
dc_red                            0000000A
delay_cntr                        00000008
delay_us                          
echo                              00000036
echo_loop                         0000003A
flags                             00000000
gpio_temp                         0000000D
init                              00000060
init_rcv_state                    
main                              00000086
pwm                               00000009
pwm_clock                         00000041
rcv_stop_bit                      00000018
read_cmd                          0000004E
receiving                         0000000A
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:29:16         PAGE 11


SYMBOL TABLE
  LABEL                             VALUE 

rst_vector                        00000000
rx_buff                           00000003
tx_bit_loop                       00000026
uart_byte                         00000001
uart_rx                           00000001
uart_tx                           0000001F
wait_loop                         00000094

Errors   :     0
Warnings :    12 reported,     0 suppressed
Messages :     2 reported,     0 suppressed


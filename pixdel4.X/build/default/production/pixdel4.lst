MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;NOM: pixdel4.asm
                      00002 ;DESCRIPTION: version 4 du pixdel.
                      00003 ;             LED RGB controlée par un PIC10F200 ou PIC10F202
                      00004 ;             commandes reçues sur GP3 en format UART 8 bits, pas de parité, 1 stop.
                      00005 ;
                      00006 ;             format commande:
                      00007 ;             0xFF id_pixdel r_level g_level b_level
                      00008 ;               0xFF synchronisation, ne doit pas être utilisé comme id_pixdel ou niveau d'intensité.
                      00009 ;               id_pixdel 0 = diffusion, id_unique = 1-254
                      00010 ;               r_level niveau de rouge 0-254
                      00011 ;               g_level niveau de vert 0-254
                      00012 ;               b_level niveau de bleu 0-254
                      00013 ;
                      00014 ;MCU: PIC10F200 ou 202
                      00015 ;DATE: 2013-03-05
                      00016 ;AUTEUR: Jacques Deschênes
                      00017 ;REVISION: 2013-03-29
                      00018 ;          version 4, réécriture complète du firmware.
                      00019 
                      00020 
                      00021   include <P10F202.INC>
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ;  MPASM PIC10F202 processor include
                      00005 ; 
                      00006 ;  (c) Copyright 1999-2013 Microchip Technology, All rights reserved
                      00007 ;==========================================================================
                      00008 
                      00150         LIST
                      00022 
0FFF   0FEB           00023   __config _WDTE_OFF & _MCLRE_OFF
                      00024 
                      00025 ;;;;;;;;;;;;; constantes ;;;;;;;;;;;;;;
  00000001            00026 PIXDEL_ID EQU 1 ; 1 à 254 doit-être différent pour chaque pixdel
                      00027 
                      00028 
  00000000            00029 BROADCAST EQU 0 ; identifiant message de diffusion
                      00030 
  000000C8            00031 OPTION_CFG EQU B'11001000' ; configuration registre OPTION
                      00032 
  00000003            00033 RX_P EQU GP3 ; réception uart
                      00034 #ifdef DEBUG
                      00035 TX_P EQU GP1 ; transmission uart
                      00036 #endif
                      00037 
  00000004            00038 CMD_SIZE EQU 4 ;  octets par commande, excluant l'octet de synchronisation
                      00039 
                      00040 ; bits couleurs rgb dans GPIO
  00000000            00041 GREEN   EQU GP0
  00000001            00042 BLUE    EQU GP1
  00000002            00043 RED     EQU GP2
                      00044 
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00045 
                      00046 ; délais de bit en usec. pour les différentes vitesse rs-232
                      00047 ; 9600 BAUD
  00000068            00048 BDLY_9600 EQU D'104' ;
  00000034            00049 HDLY_9600 EQU D'52' ; délais demi-bit
                      00050 ; 14400 BAUD
  00000045            00051 BDLY_14400 EQU D'69'
  00000023            00052 HDLY_14400 EQU D'35'
                      00053 ; 19200 BAUD
  00000034            00054 BDLY_19200 EQU D'52'
  0000001A            00055 HDLY_19200 EQU D'26'
                      00056 ; 38400 BAUD
  0000001A            00057 BDLY_38400 EQU  D'26'
  0000000D            00058 HDLY_38400 EQU  D'13'
                      00059 
                      00060 ; vitesse utilisée dans cette version
  00000068            00061 BIT_DLY  EQU BDLY_9600
  00000034            00062 HALF_DLY EQU HDLY_9600
  FFFFFFCC            00063 PWM_PERIOD EQU (~HALF_DLY) + 1 ; période entre chaque appel de pwm_clock
                      00064 
                      00065 ; indicateurs booléens
  00000000            00066 F_RDBIT EQU 0  ; toggle lecture bit à tous les 2 cycles
  00000001            00067 F_STOP EQU 1  ; réception stop bit
  00000002            00068 F_BYTE EQU 2 ; octet reçu au complet
  00000008            00069 F_CMD  EQU 8 ; commande reçu et prête à être lue
                      00070 
                      00071 
                      00072 ;;;;;;;;;;;;; macros ;;;;;;;;;;;;;;;;;;
                      00073 ;#define DEBUG
                      00074 
                      00075 #define RX GPIO, RX_P ; réception des commande sur cette broche
                      00076 #ifdef DEBUG
                      00077 #define TX GPIO, TX_P ; transmission rs-232 pour déboguage
                      00078 #endif
                      00079 
                      00080 ; délais en micro-secondes basé sur un Tcy de 1usec.
                      00081 ; délais maximal  3*255+2=767usec
                      00082 delay_us macro usec
                      00083   local q=(usec-2)/3
                      00084   if q>0
                      00085     movlw q
                      00086     movwf delay_cntr
                      00087     decfsz delay_cntr,F
                      00088     goto $-1
                      00089     nop
                      00090     local r=(usec-2) % 3
                      00091     while r>1
                      00092       goto $+1
                      00093       local r=r-2
                      00094     endw
                      00095     if r>0
                      00096       nop
                      00097     endif
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00098   else
                      00099     while usec>1
                      00100       goto $+1
                      00101       usec=usec-2
                      00102     endw
                      00103     if usec>0
                      00104       nop
                      00105     endif
                      00106   endif
                      00107   endm
                      00108 
                      00109 next_task macro next ; 2 Tcy
                      00110     movlw next
                      00111     movwf task
                      00112     endm
                      00113 
                      00114 init_state_idle macro ; 7 Tcy
                      00115     movlw CMD_SIZE
                      00116     movwf byte_cntr
                      00117     movlw rx_buff
                      00118     movwf FSR
                      00119     movlw task_wait_sync_start
                      00120     movwf task
                      00121     clrf flags
                      00122     endm
                      00123 
                      00124 init_byte_rcv macro  ; 5 Tcy
                      00125     movlw H'80'
                      00126     movwf INDF
                      00127     movlw H'F0'
                      00128     andwf flags, F
                      00129     bsf flags, F_RDBIT
                      00130     endm
                      00131 
                      00132 pwm_clock macro ; 12 Tcy
                      00133 ; contrôle l'intensité des composantes rouge,verte,bleu
                      00134     incf pwm, F
                      00135     movfw pwm
                      00136     subwf dc_red, W
                      00137     rlf gpio_temp, F
                      00138     movfw pwm
                      00139     subwf dc_blue, W
                      00140     rlf gpio_temp, F
                      00141     movfw pwm
                      00142     subwf dc_green, W
                      00143     rlf gpio_temp, F
                      00144     comf gpio_temp, W
                      00145 #ifdef DEBUG
                      00146     nop
                      00147 #else
                      00148     movwf GPIO
                      00149 #endif
                      00150     endm
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00151 
                      00152 ;;;;;;;;;;;;; variables ;;;;;;;;;;;;;;;
                      00153   udata
0000                  00154 task res 1 ; tâche en cours d'exécution
0001                  00155 flags res 1 ; indicateurs booléens
0002                  00156 byte_cntr res 1 ; compteur octets réception commande
0003                  00157 rx_buff res CMD_SIZE ; mémoire tampon réception des commandes
0007                  00158 delay_cntr res 1 ; compteur pour macro delay_us
0008                  00159 pwm res 1  ; compteur pwm
0009                  00160 dc_red res 1 ; rapport cyclique rouge
000A                  00161 dc_blue res 1 ; rapport cyclique bleu
000B                  00162 dc_green res 1 ; rappor cyclique vert
000C                  00163 gpio_temp res 1 ; variable temporaire état GPIO utilisé par tâche pwm_clock.
                      00164 #ifdef DEBUG
                      00165 uart_byte res 1 ; octet envoyé part uart_tx
                      00166 #endif
                      00167 
                      00168 ;;;;;;;;;;;;; code ;;;;;;;;;;;;;;;;;;;;
                      00169 
                      00170 rst_vector org 0
0000   0A??           00171   goto init
                      00172 
0001                  00173 uart_rx
                      00174 ; réception RS-232 
0001   0C01           00175     movlw 1<<F_RDBIT
0002   01??           00176     xorwf flags, F
0003   0700           00177     btfss flags, F_RDBIT
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0004   0800           00178     return
0005   0620           00179     btfsc flags, F_STOP
0006   0A??           00180     goto rcv_stop_bit
0007   0503           00181     setc
0008   0766           00182     btfss RX
0009   0403           00183     clrc
000A   0320           00184     rrf INDF, F
000B   0703           00185     skpc
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
000C   0800           00186     return
000D   0520           00187     bsf flags, F_STOP
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
000E   0800           00188     return
000F                  00189 rcv_stop_bit
000F   0666           00190     btfsc RX
0010   0540           00191     bsf flags, F_BYTE
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0011   0800           00192     return
                      00193 
                      00194 #ifdef DEBUG
                      00195 uart_tx
                      00196 ; transmet octet [uart_byte] , utilisé pour deboggage.
                      00197     bcf TX
                      00198     delay_us (BIT_DLY-D'6')
                      00199     setc
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00200 tx_bit_loop
                      00201     rrf uart_byte, F
                      00202     skpc
                      00203     bcf TX
                      00204     skpnc
                      00205     bsf TX
                      00206     delay_us (BIT_DLY - D'10')
                      00207     clrc
                      00208     movf uart_byte, F
                      00209     skpz
                      00210     goto tx_bit_loop
                      00211     return
                      00212 
                      00213 echo ; transmet le contenu de rx_buff, pour déboguage
                      00214     movlw rx_buff
                      00215     movwf FSR
                      00216     movlw CMD_SIZE
                      00217     movwf byte_cntr
                      00218 echo_loop
                      00219     movfw INDF
                      00220     movwf uart_byte
                      00221     call uart_tx
                      00222     incf FSR
                      00223     decfsz byte_cntr, F
                      00224     goto echo_loop
                      00225     return
                      00226 
                      00227 #endif
                      00228 
                      00229 
                      00230 ;;;;;;;;;;;; initialisation MCU ;;;;;;;
0012                  00231 init
0012   0C08           00232     movlw D'8' ; valeur obtenue expérimentalement par mesure de FOSC4=1Mhz sur GP2
0013   0025           00233     movwf OSCCAL
0014   0CC8           00234     movlw OPTION_CFG
0015   0002           00235     option
0016   0066           00236     clrf GPIO
0017   0040           00237     clrw
0018   0006           00238     tris GPIO
                      00239 #ifdef DEBUG
                      00240     comf GPIO, F
                      00241     movlw D'255'
                      00242     movwf gpio_temp
                      00243 delay_loop
                      00244     clrf TMR0
                      00245     movlw D'250'
                      00246     subwf TMR0, W
                      00247     skpc
                      00248     goto $-3
                      00249     decfsz gpio_temp, F
                      00250     goto delay_loop
                      00251     clrf GPIO
                      00252     movlw A'O'
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00253     movwf uart_byte
                      00254     call uart_tx
                      00255     movlw A'K'
                      00256     movwf uart_byte
                      00257     movwf uart_byte
                      00258     call uart_tx
                      00259 #endif
0019   00??           00260     clrf pwm
001A   0CFF           00261     movlw H'FF'
001B   00??           00262     movwf dc_red
001C   00??           00263     movwf dc_green
001D   00??           00264     movwf dc_blue
                      00265     init_state_idle
001E   0C04               M     movlw CMD_SIZE
001F   00??               M     movwf byte_cntr
0020   0C??               M     movlw rx_buff
0021   0024               M     movwf FSR
0022   0C??               M     movlw task_wait_sync_start
0023   00??               M     movwf task
0024   00??               M     clrf flags
0025   0061           00266     clrf TMR0
                      00267 
                      00268 
                      00269 ;;;;;;;;;;;; boucle principale ;;;;;;;;
                      00270 ; la tâche pwm_clock s'exécute à chaque cycle du céduleur
                      00271 ; les autres tâches s'exécute à tour de rôle selon l'état
                      00272 ; du système.
0026                  00273 main
0026   0CCE           00274     movlw PWM_PERIOD + 2
Message[305]: Using default destination of 1 (file).
0027   01E1           00275     addwf TMR0
                      00276     pwm_clock ; 12 Tcy
                          M ; contrôle l'intensité des composantes rouge,verte,bleu
0028   02??               M     incf pwm, F
0029   02??               M     movfw pwm
002A   00??               M     subwf dc_red, W
002B   03??               M     rlf gpio_temp, F
002C   02??               M     movfw pwm
002D   00??               M     subwf dc_blue, W
002E   03??               M     rlf gpio_temp, F
002F   02??               M     movfw pwm
0030   00??               M     subwf dc_green, W
0031   03??               M     rlf gpio_temp, F
0032   02??               M     comf gpio_temp, W
                          M #ifdef DEBUG
                          M     nop
                          M #else
0033   0026               M     movwf GPIO
                          M #endif
0034   02??           00277     movfw task  ; task switch
0035   0022           00278     movwf PCL   ; +17 Tcy
0036                  00279 task_wait_sync_start ; attend le bit de démarrage réception octet SYNC (0xFF)
0036   0666           00280     btfsc RX
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0037   0A??           00281     goto idle_loop ; +20Tcy
                      00282     init_byte_rcv  ; 5 Tcy
0038   0C80               M     movlw H'80'
0039   0020               M     movwf INDF
003A   0CF0               M     movlw H'F0'
003B   01??               M     andwf flags, F
003C   0500               M     bsf flags, F_RDBIT
                      00283     next_task task_sync
003D   0C??               M     movlw task_sync
003E   00??               M     movwf task
003F   0A??           00284     goto idle_loop ; +28 Tcy
0040                  00285 task_sync  ; réception octet SYNC
0040   09??           00286     call uart_rx   ; <= 15 Tcy
0041   0740           00287     btfss flags, F_BYTE
0042   0A??           00288     goto idle_loop ; <=13 Tcy
0043   0240           00289     comf INDF,W ; zéro si octet reçu = 0xFF
0044   0743           00290     skpz
0045   0A??           00291     goto no_sync
                      00292     next_task task_wait_start_bit
0046   0C??               M     movlw task_wait_start_bit
0047   00??               M     movwf task
0048   0A??           00293     goto idle_loop
0049                  00294 no_sync ; octet reçu n'est pas 0xFF
                      00295     next_task task_wait_sync_start
0049   0C??               M     movlw task_wait_sync_start
004A   00??               M     movwf task
004B   0A??           00296     goto idle_loop
004C                  00297 task_wait_start_bit  ; attend bit de démarrage réception des octets de commandes
004C   0666           00298     btfsc RX
004D   0A??           00299     goto idle_loop
                      00300     init_byte_rcv
004E   0C80               M     movlw H'80'
004F   0020               M     movwf INDF
0050   0CF0               M     movlw H'F0'
0051   01??               M     andwf flags, F
0052   0500               M     bsf flags, F_RDBIT
                      00301     next_task task_cmd_rcv
0053   0C??               M     movlw task_cmd_rcv
0054   00??               M     movwf task
0055   0A??           00302     goto idle_loop
0056                  00303 task_cmd_rcv ; réception d'un octet de commande.
0056   09??           00304     call uart_rx
0057   0740           00305     btfss flags, F_BYTE
0058   0A??           00306     goto idle_loop
Message[305]: Using default destination of 1 (file).
0059   02A4           00307     incf FSR
                      00308     next_task task_wait_start_bit
005A   0C??               M     movlw task_wait_start_bit
005B   00??               M     movwf task
005C   02??           00309     decfsz byte_cntr, F
005D   0A??           00310     goto idle_loop
                      00311 #ifdef DEBUG
                      00312     call echo
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00313     init_state_idle ; 7
                      00314     goto main
                      00315 #else
005E   0C??           00316     movlw task_chk_id
005F   00??           00317     movwf task
0060   0A??           00318     goto idle_loop
0061                  00319 task_chk_id ; vérifie l'identifiant avant d'accepter la commande
0061   0C??           00320     movlw rx_buff
0062   0024           00321     movwf FSR
0063   0200           00322     movf INDF, W
0064   0643           00323     skpnz
0065   0A??           00324     goto accept_cmd
0066   0F01           00325     xorlw PIXDEL_ID
0067   0743           00326     skpz
0068   0A??           00327     goto deny_cmd
0069                  00328 accept_cmd  ; commande acceptée.
                      00329     next_task task_cmd 
0069   0C??               M     movlw task_cmd
006A   00??               M     movwf task
006B   0A??           00330     goto idle_loop
006C                  00331 deny_cmd ; commande refusée, mauvais pixdel_id
                      00332     init_state_idle ; 7
006C   0C04               M     movlw CMD_SIZE
006D   00??               M     movwf byte_cntr
006E   0C??               M     movlw rx_buff
006F   0024               M     movwf FSR
0070   0C??               M     movlw task_wait_sync_start
0071   00??               M     movwf task
0072   00??               M     clrf flags
0073   0A??           00333     goto idle_loop
                      00334 #endif
0074                  00335 task_cmd ; exécution de la commande reçue.
0074   02A4           00336     incf FSR, F
0075   0240           00337     comf INDF, W
0076   00??           00338     movwf dc_red
0077   02A4           00339     incf FSR, F
0078   0240           00340     comf INDF, W
0079   00??           00341     movwf dc_green
007A   02A4           00342     incf FSR, F
007B   0240           00343     comf INDF, W
007C   00??           00344     movwf dc_blue
                      00345     init_state_idle ; retour à l'état initial.
007D   0C04               M     movlw CMD_SIZE
007E   00??               M     movwf byte_cntr
007F   0C??               M     movlw rx_buff
0080   0024               M     movwf FSR
0081   0C??               M     movlw task_wait_sync_start
0082   00??               M     movwf task
0083   00??               M     clrf flags
0084                  00346 idle_loop ; complète le temps pour une période PWM constante
0084   0CCC           00347     movlw PWM_PERIOD
0085   0081           00348     subwf TMR0, W
0086   0603           00349     skpnc
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0087   0A??           00350     goto idle_loop
0088   0A??           00351     goto main
0FEB                  00352     end
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE 10


SYMBOL TABLE
  LABEL                             VALUE 

BDLY_14400                        00000045
BDLY_19200                        00000034
BDLY_38400                        0000001A
BDLY_9600                         00000068
BIT_DLY                           00000068
BLUE                              00000001
BROADCAST                         00000000
C                                 00000000
CAL0                              00000001
CAL1                              00000002
CAL2                              00000003
CAL3                              00000004
CAL4                              00000005
CAL5                              00000006
CAL6                              00000007
CMD_SIZE                          00000004
DC                                00000001
F                                 00000001
FOSC4                             00000000
FSR                               00000004
F_BYTE                            00000002
F_CMD                             00000008
F_RDBIT                           00000000
F_STOP                            00000001
GP0                               00000000
GP1                               00000001
GP2                               00000002
GP3                               00000003
GPIO                              00000006
GPWUF                             00000007
GREEN                             00000000
HALF_DLY                          00000034
HDLY_14400                        00000023
HDLY_19200                        0000001A
HDLY_38400                        0000000D
HDLY_9600                         00000034
INDF                              00000000
NOT_GPPU                          00000006
NOT_GPWU                          00000007
NOT_PD                            00000003
NOT_TO                            00000004
OPTION_CFG                        000000C8
OSCCAL                            00000005
PCL                               00000002
PIXDEL_ID                         00000001
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PWM_PERIOD                        FFFFFFCC
RED                               00000002
RX                                GPIO, RX_P
RX_P                              00000003
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE 11


SYMBOL TABLE
  LABEL                             VALUE 

STATUS                            00000003
T0CS                              00000005
T0SE                              00000004
TMR0                              00000001
TRISIO0                           00000000
TRISIO1                           00000001
TRISIO2                           00000002
TRISIO3                           00000003
W                                 00000000
Z                                 00000002
_CONFIG                           00000FFF
_CP_OFF                           00000FFF
_CP_ON                            00000FF7
_IDLOC0                           00000200
_IDLOC1                           00000201
_IDLOC2                           00000202
_IDLOC3                           00000203
_IntRC_OSC                        00000FFF
_MCLRE_OFF                        00000FEF
_MCLRE_ON                         00000FFF
_OSC_IntRC                        00000FFF
_WDTE_OFF                         00000FFB
_WDTE_ON                          00000FFF
_WDT_OFF                          00000FFB
_WDT_ON                           00000FFF
__10F202                          00000001
accept_cmd                        00000069
byte_cntr                         00000002
dc_blue                           0000000A
dc_green                          0000000B
dc_red                            00000009
delay_cntr                        00000007
delay_us                          
deny_cmd                          0000006C
flags                             00000001
gpio_temp                         0000000C
idle_loop                         00000084
init                              00000012
init_byte_rcv                     
init_state_idle                   
main                              00000026
next_task                         
no_sync                           00000049
pwm                               00000008
pwm_clock                         
rcv_stop_bit                      0000000F
rst_vector                        00000000
rx_buff                           00000003
task                              00000000
task_chk_id                       00000061
task_cmd                          00000074
task_cmd_rcv                      00000056
task_sync                         00000040
MPASM  5.49                       PIXDEL4.ASM   3-29-2013  17:23:36         PAGE 12


SYMBOL TABLE
  LABEL                             VALUE 

task_wait_start_bit               0000004C
task_wait_sync_start              00000036
uart_rx                           00000001

Errors   :     0
Warnings :     4 reported,     0 suppressed
Messages :     2 reported,     0 suppressed


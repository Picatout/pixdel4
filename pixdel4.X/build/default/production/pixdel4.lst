MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;NOM: pixdel4.asm
                      00002 ;DESCRIPTION: version 3 du pixdel (version simplifiée).
                      00003 ;             LED RGB controlée par un PIC10F200 ou PIC10F202
                      00004 ;             commandes reçues sur GP3 en format UART 8 bits, pas de parité, 1 stop.
                      00005 ;
                      00006 ;             format commande:
                      00007 ;             0xFF id_pixdel r_level g_level b_level
                      00008 ;               0xFF synchronisation, ne doit pas être utilisé comme id_pixdel ou niveau d'intensité.
                      00009 ;               id_pixdel 0 = diffusion, id_unique 1-254
                      00010 ;               r_level niveau de rouge 0-254
                      00011 ;               g_level niveau de vert 0-254
                      00012 ;               b_level niveau de bleu 0-254
                      00013 ;
                      00014 ;MCU: PIC10F200 ou 202
                      00015 ;DATE: 2013-03-05
                      00016 ;AUTEUR: Jacques Deschênes
                      00017 ;REVISION: 2013-03-23
                      00018 ;          version 4, augmentation de la vitesse uart_rx à 38400 BAUD
                      00019 
                      00020 
                      00021   include <P10F202.INC>
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ;  MPASM PIC10F202 processor include
                      00005 ; 
                      00006 ;  (c) Copyright 1999-2013 Microchip Technology, All rights reserved
                      00007 ;==========================================================================
                      00008 
                      00150         LIST
                      00022 
0FFF   0FEB           00023   __config _WDTE_OFF & _MCLRE_OFF
                      00024 
                      00025 ;;;;;;;;;;;;; constantes ;;;;;;;;;;;;;;
                      00026 ;PIXDEL_ID EQU 1 ; 1-255 doit-être différent pour chaque pixdel
                      00027 ; pour des raisons pratique PIXDEL_ID est maintenant défini sur comme macro
                      00028 ; de ligne de commande mpasm.   mpasm -d PIXDEL_ID=n
                      00029 ;
                      00030 
  00000000            00031 BROADCAST EQU 0 ; identifiant message de diffusion
                      00032 
  000000C8            00033 OPTION_CFG EQU B'11001000' ; configuration registre OPTION
                      00034 
  00000003            00035 RX_P EQU GP3 ; réception uart
  00000001            00036 TX_P EQU GP1 ; transmission uart
                      00037 
  00000004            00038 CMD_SIZE EQU 4 ;  octets par commande
                      00039 
                      00040 ; bits couleurs rgb dans GPIO
  00000000            00041 GREEN   EQU GP0
  00000001            00042 BLUE    EQU GP1
  00000002            00043 RED     EQU GP2
                      00044 
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00045 
                      00046 ; délais de bit pour 9600 BAUD
  00000068            00047 BDLY_9600 EQU D'104' ;
  00000034            00048 HDLY_9600 EQU D'52' ; délais demi-bit
  00000045            00049 BDLY_14400 EQU D'69'
  00000023            00050 HDLY_14400 EQU D'35'
                      00051 ;délais de bit pour 19200 BAUD
  00000034            00052 BDLY_19200 EQU D'52'
  0000001A            00053 HDLY_19200 EQU D'26'
                      00054 ; délais de bit pour 38400 BAUD
  0000001A            00055 BDLY_38400 EQU  D'26'
  0000000D            00056 HDLY_38400 EQU  D'13'
                      00057 
  00000068            00058 BIT_DLY  EQU BDLY_9600
  00000034            00059 HALF_DLY EQU HDLY_9600
  FFFFFFCC            00060 PWM_PERIOD EQU (~HALF_DLY) + 1 ; période entre chaque appel de pwm_clock
                      00061 
                      00062 ; indicateurs booléens
  00000000            00063 F_IDLE EQU 0 ; pas de réception en cours
  00000001            00064 F_RDBIT EQU 1  ; toggle lecture bit à tous les 2 cycles
  00000002            00065 F_STOP EQU 2  ; réception stop bit
  00000003            00066 F_SYNC EQU 3 ; réception octet de synchronisation
  00000004            00067 F_CMD  EQU 4 ; commande reçu et prête à être lue
                      00068 
                      00069 
                      00070 ;;;;;;;;;;;;; macros ;;;;;;;;;;;;;;;;;;
                      00071 ;#define DEBUG
                      00072 
                      00073 #define RX GPIO, RX_P
                      00074 #define TX GPIO, TX_P
                      00075 
                      00076 ; délais en micro-secondes basé sur un Tcy de 1usec.
                      00077 ; délais maximal  3*255+2=767usec
                      00078 delay_us macro usec
                      00079   local q=(usec-2)/3
                      00080   if q>0
                      00081     movlw q
                      00082     movwf delay_cntr
                      00083     decfsz delay_cntr,F
                      00084     goto $-1
                      00085     nop
                      00086     local r=(usec-2) % 3
                      00087     while r>1
                      00088       goto $+1
                      00089       local r=r-2
                      00090     endw
                      00091     if r>0
                      00092       nop
                      00093     endif
                      00094   else
                      00095     while usec>1
                      00096       goto $+1
                      00097       usec=usec-2
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00098     endw
                      00099     if usec>0
                      00100       nop
                      00101     endif
                      00102   endif
                      00103   endm
                      00104 
                      00105 init_rcv_state macro
                      00106     movlw CMD_SIZE
                      00107     movwf byte_cntr
                      00108     movlw rx_buff
                      00109     movwf FSR
                      00110     clrf flags
                      00111     bsf flags, F_IDLE
                      00112     bsf flags, F_SYNC
                      00113     endm
                      00114 
                      00115 
                      00116 ;;;;;;;;;;;;; variables ;;;;;;;;;;;;;;;
                      00117   udata
0000                  00118 flags res 1 ; indicateurs booléens
0001                  00119 uart_byte res 1 ; octet reçu sur entrée uart
0002                  00120 byte_cntr res 1 ; registre temporaire
0003                  00121 rx_buff res CMD_SIZE ; mémoire tampon réception des commandes
0007                  00122 delay_cntr res 1 ; compteur pour macro delay_us
0008                  00123 pwm res 1  ; compteur pwm
0009                  00124 dc_red res 1 ; rapport cyclique rouge
000A                  00125 dc_blue res 1 ; rapport cyclique bleu
000B                  00126 dc_green res 1 ; rappor cyclique vert
000C                  00127 gpio_temp res 1 ; variable temporaire état GPIO utilisé par tâche PWM.
                      00128 
                      00129 ;;;;;;;;;;;;; code ;;;;;;;;;;;;;;;;;;;;
                      00130 
                      00131 rst_vector org 0
0000   0A??           00132   goto init
                      00133 
0001                  00134 uart_rx
                      00135 ; réception RS-232 
0001   0700           00136   btfss flags, F_IDLE
0002   0A??           00137   goto receiving
0003   0666           00138   btfsc RX
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0004   0800           00139   return 
0005   0C80           00140   movlw H'80'
0006   0020           00141   movwf INDF
0007   0400           00142   bcf flags, F_IDLE
0008   0520           00143   bsf flags, F_RDBIT
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0009   0800           00144   return
000A                  00145 receiving
000A   0C02           00146   movlw 1<<F_RDBIT
000B   01??           00147   xorwf flags, F
000C   0720           00148   btfss flags, F_RDBIT
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
000D   0800           00149   return
000E   0640           00150   btfsc flags, F_STOP
000F   0A??           00151   goto rcv_stop_bit
0010   0503           00152   setc
0011   0766           00153   btfss RX
0012   0403           00154   clrc
0013   0320           00155   rrf INDF, F
0014   0703           00156   skpc
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0015   0800           00157   return
0016   0540           00158   bsf flags, F_STOP
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0017   0800           00159   return
0018                  00160 rcv_stop_bit
0018   0660           00161   btfsc flags,F_SYNC
0019   0A??           00162   goto chk_sync
001A   00??           00163   clrf flags
001B   0500           00164   bsf flags, F_IDLE
001C   02A4           00165   incf FSR, F
001D   02??           00166   decfsz byte_cntr, F
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
001E   0800           00167   return
001F   0580           00168   bsf flags, F_CMD
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0020   0800           00169   return
0021                  00170 chk_sync
0021   00??           00171   clrf flags
0022   0500           00172   bsf flags, F_IDLE
0023   0240           00173   comf INDF, W
0024   0643           00174   skpnz
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0025   0800           00175   return
0026   0560           00176   bsf flags, F_SYNC
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0027   0800           00177   return
                      00178 
                      00179 
                      00180 #ifdef DEBUG
                      00181 uart_tx
                      00182 ; transmet octet [uart_byte] , utilisé pur deboggage.
                      00183   bcf TX
                      00184   delay_us (BIT_DLY-D'6')
                      00185   setc
                      00186 tx_bit_loop
                      00187   rrf uart_byte, F
                      00188   skpc
                      00189   bcf TX
                      00190   skpnc
                      00191   bsf TX
                      00192   delay_us (BIT_DLY - D'10')
                      00193   clrc
                      00194   movf uart_byte, F
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00195   skpz
                      00196   goto tx_bit_loop
                      00197   return
                      00198 
                      00199 echo
                      00200   movlw rx_buff
                      00201   movwf FSR
                      00202   movlw CMD_SIZE
                      00203   movwf byte_cntr
                      00204 echo_loop
                      00205   movfw INDF
                      00206   movwf uart_byte
                      00207   call uart_tx
                      00208   incf FSR
                      00209   decfsz byte_cntr, F
                      00210   goto echo_loop
                      00211   return
                      00212 
                      00213 #endif
                      00214 
                      00215 
0028                  00216 pwm_clock ; 16 uSec inclant call et return
0028   02??           00217     incf pwm, F
0029   02??           00218     movfw pwm
002A   00??           00219     subwf dc_red, W
002B   03??           00220     rlf gpio_temp, F
002C   02??           00221     movfw pwm
002D   00??           00222     subwf dc_blue, W
002E   03??           00223     rlf gpio_temp, F
002F   02??           00224     movfw pwm
0030   00??           00225     subwf dc_green, W
0031   03??           00226     rlf gpio_temp, F
0032   02??           00227     comf gpio_temp, W
                      00228 #ifdef DEBUG
                      00229     nop
                      00230 #else
0033   0026           00231     movwf GPIO
                      00232 #endif
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0034   0800           00233     return
                      00234 
0035                  00235 read_cmd ;+4
0035   0C??           00236     movlw rx_buff
0036   0024           00237     movwf FSR
0037   0200           00238     movf INDF, W
0038   0643           00239     skpnz
0039   0A??           00240     goto accept_cmd
003A   0F01           00241     xorlw PIXDEL_ID
003B   0743           00242     skpz
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
003C   0800           00243     return
003D                  00244 accept_cmd
003D   02A4           00245     incf FSR, F
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

003E   0240           00246     comf INDF, W
003F   00??           00247     movwf dc_red
0040   02A4           00248     incf FSR, F
0041   0240           00249     comf INDF, W
0042   00??           00250     movwf dc_green
0043   02A4           00251     incf FSR, F
0044   0240           00252     comf INDF, W
0045   00??           00253     movwf dc_blue
Warning[227]: Substituting RETLW 0 for RETURN pseudo-op
0046   0800           00254     return 
                      00255 
                      00256 
                      00257 ;;;;;;;;;;;; initialisation MCU ;;;;;;;
0047                  00258 init
0047   0C08           00259   movlw D'8' ; valeur obtenue expérimentalement par mesure de FOSC4 sur GP2
0048   0025           00260   movwf OSCCAL
0049   0CC8           00261   movlw OPTION_CFG
004A   0002           00262   option
004B   0040           00263   clrw
004C   0006           00264   tris GPIO
004D   0546           00265   bsf GPIO, RED
004E   0506           00266   bsf GPIO, GREEN
004F   0526           00267   bsf GPIO, BLUE
0050   0CFF           00268   movlw D'255'
0051   00??           00269   movwf gpio_temp
0052   0061           00270   clrf TMR0
0053   0CFA           00271   movlw D'250'
0054   0081           00272   subwf TMR0, W
0055   0703           00273   skpc
0056   0A??           00274   goto $-3
0057   02??           00275   decfsz gpio_temp, F
0058   0A??           00276   goto $-6
0059   0066           00277   clrf GPIO
005A   00??           00278   clrf pwm
005B   0CFF           00279   movlw H'FF'
005C   00??           00280   movwf dc_red
005D   00??           00281   movwf dc_green
005E   00??           00282   movwf dc_blue
                      00283 #ifdef DEBUG
                      00284   movlw A'O'
                      00285   movwf uart_byte
                      00286   call uart_tx
                      00287   movlw A'K'
                      00288   movwf uart_byte
                      00289   movwf uart_byte
                      00290   call uart_tx
                      00291 #endif
                      00292   init_rcv_state
005F   0C04               M     movlw CMD_SIZE
0060   00??               M     movwf byte_cntr
0061   0C??               M     movlw rx_buff
0062   0024               M     movwf FSR
0063   00??               M     clrf flags
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0064   0500               M     bsf flags, F_IDLE
0065   0560               M     bsf flags, F_SYNC
0066   0061           00293   clrf TMR0
                      00294 
                      00295 ;;;;;;;;;;;; boucle principale ;;;;;;;;
0067                  00296 main
0067   0CCE           00297     movlw PWM_PERIOD + 2
Message[305]: Using default destination of 1 (file).
0068   01E1           00298     addwf TMR0
0069   09??           00299     call pwm_clock ; 16uSec
006A   09??           00300     call uart_rx   
006B   0780           00301     btfss flags, F_CMD
006C   0A??           00302     goto wait_loop
                      00303 #ifdef DEBUG
                      00304     call echo
                      00305 #else
006D   09??           00306     call read_cmd
                      00307 #endif
                      00308     init_rcv_state
006E   0C04               M     movlw CMD_SIZE
006F   00??               M     movwf byte_cntr
0070   0C??               M     movlw rx_buff
0071   0024               M     movwf FSR
0072   00??               M     clrf flags
0073   0500               M     bsf flags, F_IDLE
0074   0560               M     bsf flags, F_SYNC
0075   0A??           00309     goto main
0076                  00310 wait_loop
0076   0CCC           00311     movlw PWM_PERIOD
0077   0081           00312     subwf TMR0, W
0078   0603           00313     skpnc
0079   0A??           00314     goto wait_loop
007A   0A??           00315     goto main
0FEB                  00316     end
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  8


SYMBOL TABLE
  LABEL                             VALUE 

BDLY_14400                        00000045
BDLY_19200                        00000034
BDLY_38400                        0000001A
BDLY_9600                         00000068
BIT_DLY                           00000068
BLUE                              00000001
BROADCAST                         00000000
C                                 00000000
CAL0                              00000001
CAL1                              00000002
CAL2                              00000003
CAL3                              00000004
CAL4                              00000005
CAL5                              00000006
CAL6                              00000007
CMD_SIZE                          00000004
DC                                00000001
F                                 00000001
FOSC4                             00000000
FSR                               00000004
F_CMD                             00000004
F_IDLE                            00000000
F_RDBIT                           00000001
F_STOP                            00000002
F_SYNC                            00000003
GP0                               00000000
GP1                               00000001
GP2                               00000002
GP3                               00000003
GPIO                              00000006
GPWUF                             00000007
GREEN                             00000000
HALF_DLY                          00000034
HDLY_14400                        00000023
HDLY_19200                        0000001A
HDLY_38400                        0000000D
HDLY_9600                         00000034
INDF                              00000000
NOT_GPPU                          00000006
NOT_GPWU                          00000007
NOT_PD                            00000003
NOT_TO                            00000004
OPTION_CFG                        000000C8
OSCCAL                            00000005
PCL                               00000002
PIXDEL_ID                         1
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PWM_PERIOD                        FFFFFFCC
RED                               00000002
RX                                GPIO, RX_P
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE  9


SYMBOL TABLE
  LABEL                             VALUE 

RX_P                              00000003
STATUS                            00000003
T0CS                              00000005
T0SE                              00000004
TMR0                              00000001
TRISIO0                           00000000
TRISIO1                           00000001
TRISIO2                           00000002
TRISIO3                           00000003
TX                                GPIO, TX_P
TX_P                              00000001
W                                 00000000
Z                                 00000002
_.org_0_0056                      00000056
_.org_0_0058                      00000058
_CONFIG                           00000FFF
_CP_OFF                           00000FFF
_CP_ON                            00000FF7
_IDLOC0                           00000200
_IDLOC1                           00000201
_IDLOC2                           00000202
_IDLOC3                           00000203
_IntRC_OSC                        00000FFF
_MCLRE_OFF                        00000FEF
_MCLRE_ON                         00000FFF
_OSC_IntRC                        00000FFF
_WDTE_OFF                         00000FFB
_WDTE_ON                          00000FFF
_WDT_OFF                          00000FFB
_WDT_ON                           00000FFF
__10F202                          00000001
accept_cmd                        0000003D
byte_cntr                         00000002
chk_sync                          00000021
dc_blue                           0000000A
dc_green                          0000000B
dc_red                            00000009
delay_cntr                        00000007
delay_us                          
flags                             00000000
gpio_temp                         0000000C
init                              00000047
init_rcv_state                    
main                              00000067
pwm                               00000008
pwm_clock                         00000028
rcv_stop_bit                      00000018
read_cmd                          00000035
receiving                         0000000A
rst_vector                        00000000
rx_buff                           00000003
uart_byte                         00000001
uart_rx                           00000001
MPASM  5.49                       PIXDEL4.ASM   3-28-2013  20:42:54         PAGE 10


SYMBOL TABLE
  LABEL                             VALUE 

wait_loop                         00000076

Errors   :     0
Warnings :    12 reported,     0 suppressed
Messages :     1 reported,     0 suppressed

